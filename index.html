<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View, Update & Delete Save File</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2em auto; }
    label { display: block; margin-top: 1em; }
    textarea { width: 100%; height: 200px; }
    input, button { margin-top: 0.5em; }
    #result { margin-top: 1em; color: green; }
    #error { margin-top: 1em; color: red; }
  </style>
</head>
<body>
  <h2>View, Update & Delete Save File</h2>
  <form id="saveForm" onsubmit="return false;">
    <label>
      Username:
      <input type="text" id="username" required placeholder="Enter your username">
    </label>
    <button type="button" onclick="getSave()">Get Save</button>
    <button type="button" onclick="deleteSave()" style="margin-left: 1em; color: red;">Reset User</button>
    <label>
      Save Data (JSON):
      <textarea id="saveData" required placeholder='{"money":99999,"eps":5000,"inventory":[]}'></textarea>
    </label>
    <button type="button" onclick="updateSave()">Update Save</button>
  </form>
  <pre id="result"></pre>
  <pre id="error"></pre>

<h3>All Player Saves</h3>
<button type="button" onclick="listPlayers()">List Players</button>
<ul id="playerList"></ul>


  <script>
    async function getSave() {
      document.getElementById('result').textContent = '';
      document.getElementById('error').textContent = '';
      const username = document.getElementById('username').value.trim();
      if (!username) {
        document.getElementById('error').textContent = 'Username is required.';
        return;
      }
      const url = `https://flex-sdww.onrender.com/api/game/rawsave?user=${encodeURIComponent(username)}`;
      try {
        const res = await fetch(url);
        if (!res.ok) {
          const result = await res.json();
          throw new Error(result.error || res.statusText);
        }
        const data = await res.json();
        document.getElementById('saveData').value = JSON.stringify(data, null, 2);
        document.getElementById('result').textContent = 'Save file loaded. You can now edit and update.';
      } catch (err) {
        document.getElementById('error').textContent = 'Error: ' + err.message;
      }
    }

    async function updateSave() {
      document.getElementById('result').textContent = '';
      document.getElementById('error').textContent = '';
      const username = document.getElementById('username').value.trim();
      let saveData;
      try {
        saveData = JSON.parse(document.getElementById('saveData').value);
      } catch (e) {
        document.getElementById('error').textContent = 'Invalid JSON: ' + e.message;
        return;
      }
      if (!username) {
        document.getElementById('error').textContent = 'Username is required.';
        return;
      }
      const url = `https://flex-sdww.onrender.com/api/game/rawsave?user=${encodeURIComponent(username)}`;
      try {
        const res = await fetch(url, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(saveData)
        });
        const result = await res.json();
        if (res.ok) {
          document.getElementById('result').textContent = 'Save file updated: ' + JSON.stringify(result, null, 2);
        } else {
          document.getElementById('error').textContent = 'Error: ' + (result.error || res.statusText);
        }
      } catch (err) {
        document.getElementById('error').textContent = 'Request failed: ' + err.message;
      }
    }

    async function deleteSave() {
      document.getElementById('result').textContent = '';
      document.getElementById('error').textContent = '';
      const usernameElem = document.getElementById('username');
      const username = usernameElem.value.trim();
      if (!username) {
        document.getElementById('error').textContent = 'Username is required.';
        return;
      }
      if (!confirm(`Are you sure you want to delete the save file for "${username}"? This cannot be undone.`)) {
        return;
      }
      const url = `https://flex-sdww.onrender.com/api/game/rawsave?user=${encodeURIComponent(username)}`;
      try {
        const res = await fetch(url, { method: 'DELETE' });
        const result = await res.json();
        if (res.ok) {
          document.getElementById('result').textContent = 'Save file deleted: ' + JSON.stringify(result, null, 2);
          document.getElementById('saveData').value = '';
          usernameElem.value = ''; // <-- Clears the username field!
        } else {
          document.getElementById('error').textContent = 'Error: ' + (result.error || res.statusText);
        }
      } catch (err) {
        document.getElementById('error').textContent = 'Request failed: ' + err.message;
      }
    }


  // Your other admin functions like getSave, updateSave, etc.

  // Replace your existing listPlayers with this:
  async function listPlayers() {
  document.getElementById('result').textContent = '';
  document.getElementById('error').textContent = '';
  const listElem = document.getElementById('playerList');
  listElem.innerHTML = 'Loading...';

  try {
    const res = await fetch('https://flex-sdww.onrender.com/api/game/list');
    if (!res.ok) throw new Error('Failed to fetch player list');
    const players = await res.json();

    listElem.innerHTML = '';
    players.forEach(user => {
      const li = document.createElement('li');

      // Download button
      const btnDownload = document.createElement('button');
      btnDownload.textContent = `Download ${user}`;
      btnDownload.onclick = () => downloadSave(user);

      // --- NEW: Get Save button ---
      const btnGetSave = document.createElement('button');
      btnGetSave.textContent = `Get ${user} Save`;
      btnGetSave.onclick = () => getSave(user);

      // Delete button
      const btnDelete = document.createElement('button');
      btnDelete.textContent = `Delete ${user}`;
      btnDelete.style.color = 'red';
      btnDelete.onclick = () => deletePlayerSave(user);

      li.textContent = user + ' ';
      li.appendChild(btnDownload);
      li.appendChild(btnGetSave);   // <--- Your new button here!
      li.appendChild(btnDelete);
      listElem.appendChild(li);
    });
  } catch (err) {
    document.getElementById('error').textContent = 'Error: ' + err.message;
  }
}

  // Add this function below listPlayers
  async function deletePlayerSave(username) {
    if (!confirm(`Are you sure you want to delete the save file for "${username}"? This cannot be undone.`)) {
      return;
    }
    try {
      const url = `https://flex-sdww.onrender.com/api/game/rawsave?user=${encodeURIComponent(username)}`;
      const res = await fetch(url, { method: 'DELETE' });
      const result = await res.json();
      if (res.ok) {
        document.getElementById('result').textContent = 'Save file deleted: ' + JSON.stringify(result, null, 2);
        listPlayers(); // Refresh the player list after deletion
      } else {
        document.getElementById('error').textContent = 'Error: ' + (result.error || res.statusText);
      }
    } catch (err) {
      document.getElementById('error').textContent = 'Request failed: ' + err.message;
    }
  }

async function downloadSave(username) {
  try {
    const url = `https://flex-sdww.onrender.com/api/game/rawsave?user=${encodeURIComponent(username)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to fetch save for ' + username);
    const data = await res.json();
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${username}_save.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  } catch (err) {
    document.getElementById('error').textContent = 'Error: ' + err.message;
  }
}



  </script>
</body>
</html>
